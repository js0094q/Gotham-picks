<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Sports Odds Aggregator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif;background-color:#111827}
    .brand-gold{color:#D97706}
    .card{background-color:#1F2937;border:1px solid #374151}
    .btn-add{transition:all .2s}
    .btn-add:hover{transform:scale(1.1);color:#FBBF24}
    .editor-pick-card{background:linear-gradient(135deg,#374151,#1F2937);border-left:4px solid #D97706}
    .top-pick-card{background:#1F2937;border-left:4px solid #10B981}
    .top-prop-card{background:#1F2937;border-left:4px solid #06B6D4}
    .best-odd{background-color:rgba(16,185,129,.3);font-weight:700;border-radius:4px}
    .aggregate-row{background-color:#064e3b;color:#a7f3d0}
    .tab{transition:background-color .2s,color .2s}
    .tab-active{background-color:#D97706;color:#111827}
    .tab-content{display:none}
    .tab-content-active{display:block}
    .loader{border:4px solid #374151;border-top:4px solid #D97706;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body class="text-gray-200">
  <!-- Header -->
  <header class="bg-gray-900/80 backdrop-blur-sm shadow-lg sticky top-0 z-10">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center space-x-3">
          <svg class="h-8 w-8 text-amber-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <h1 class="text-2xl font-bold tracking-tighter text-white">
            <span class="brand-gold">Odds</span>Aggregator
          </h1>
        </div>
        <div class="text-xs text-gray-400"><p>Live Odds from All Available Books</p></div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto p-4 sm:p-6 lg:p-8" aria-live="polite">
    <!-- Editor's Choice -->
    <section id="editors-choice" class="mb-12">
      <h2 class="text-3xl font-bold mb-4 border-b-2 border-amber-500 pb-2 flex items-center">
        <svg class="w-8 h-8 mr-3 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
        Editor's Choice
      </h2>
      <div id="editors-picks-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div id="picks-loader" class="col-span-full flex justify-center items-center py-8 hidden"><div class="loader"></div></div>
        <p id="no-picks-message" class="col-span-full text-gray-400 italic">No editor picks have been selected yet. Add a bet below to feature it here!</p>
      </div>
    </section>

    <!-- Top 5 Bets -->
    <section id="top-picks" class="mb-12">
      <h2 class="text-3xl font-bold mb-4 border-b-2 border-emerald-500 pb-2 flex items-center">
        <svg class="w-8 h-8 mr-3 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
        </svg>
        Top 5 Statistically Likely Bets
      </h2>
      <div id="top-picks-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6"></div>
    </section>

    <!-- Top 5 Player Props -->
    <section id="top-player-props" class="mb-12">
      <h2 class="text-3xl font-bold mb-4 border-b-2 border-cyan-500 pb-2 flex items-center">
        <svg class="w-8 h-8 mr-3 text-cyan-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        Top 5 Statistically Likely Player Props
      </h2>
      <div id="top-player-props-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
        <p class="col-span-full text-gray-400 italic">Explore player props in the games below to populate this list.</p>
      </div>
    </section>

    <!-- NFL Games -->
    <section>
      <h2 class="text-3xl font-bold mb-4 border-b-2 border-gray-600 pb-2">Upcoming NFL Games</h2>
      <div id="games-container" class="space-y-8"></div>
    </section>
  </main>

  <!-- App logic -->
  <script type="module">
    // Config (no API key here)
    const SPORT = 'americanfootball_nfl';
    const REGIONS = 'us';
    const ODDS_FORMAT = 'american';
    const MAIN_MARKETS = 'h2h,spreads,totals';
    const PROPS_MARKETS = 'player_pass_yds,player_pass_tds,player_rush_yds,player_reception_yds,player_anytime_td';

    // Global state + DOM refs
    let fetchedGames = [];
    let allPlayerPropBets = [];
    const gamesContainer = document.getElementById('games-container');
    const picksContainer = document.getElementById('editors-picks-container');
    const noPicksMessage = document.getElementById('no-picks-message');
    const picksLoader = document.getElementById('picks-loader');
    const topPicksContainer = document.getElementById('top-picks-container');
    const topPlayerPropsContainer = document.getElementById('top-player-props-container');

    // Helpers
    function americanToProb(odds){ return odds>=100?100/(odds+100):(-odds)/((-odds)+100) }
    function probToAmerican(prob){ return prob>=0.5? -((prob/(1-prob))*100) : (100/prob)-100 }
    function betterAmerican(a,b){
      if(a==null) return b; if(b==null) return a;
      if(a>=100&&b>=100) return a>b?a:b;
      if(a<0&&b<0) return a>b?a:b;
      return a>b?a:b;
    }
    const formatOdds = (o)=> o>0?`+${Math.round(o)}`:Math.round(o);

    // Renderers
    const renderGames = (games)=>{
      if(!gamesContainer) return;
      gamesContainer.innerHTML='';
      if(!games.length){
        gamesContainer.innerHTML='<p class="text-gray-400 text-center">No upcoming NFL games found. Try again shortly.</p>'; return;
      }
      games.forEach(game=>{
        const card=document.createElement('div');
        card.className='card rounded-lg shadow-xl overflow-hidden';
        card.id=game.id;
        card.innerHTML=`
          <div class="p-4 bg-gray-900 flex justify-between items-center">
            <div>
              <p class="text-xl font-bold">${game.awayTeam} @ ${game.homeTeam}</p>
              <p class="text-sm text-gray-400">${game.time}</p>
            </div>
          </div>
          <div class="p-2 bg-gray-800 border-b-2 border-gray-700">
            <div class="flex space-x-1">
              <button class="tab tab-active flex-1 p-2 rounded text-sm font-semibold" data-tab="game-lines">Game Lines</button>
              <button class="tab flex-1 p-2 rounded text-sm font-semibold" data-tab="player-props">Player Props</button>
            </div>
          </div>
          <div class="p-2">
            <div id="game-lines-${game.id}" class="tab-content tab-content-active"></div>
            <div id="player-props-${game.id}" class="tab-content"></div>
          </div>`;
        gamesContainer.appendChild(card);
        renderGameLines(game);
      });
    };

    const renderGameLines = (game)=>{
      const container=document.getElementById(`game-lines-${game.id}`);
      if(!container) return;

      const mlAways = game.odds.map(o=>o.moneyline?.away).filter(Number.isFinite);
      const mlHomes = game.odds.map(o=>o.moneyline?.home).filter(Number.isFinite);
      const bestAway = mlAways.length? Math.max(...mlAways) : null;
      const bestHome = mlHomes.length? Math.max(...mlHomes) : null;

      const validSpreads = game.odds.filter(o=>o.spread?.value);
      const avgSpread = validSpreads.length? (validSpreads.reduce((s,o)=>s+o.spread.value,0)/validSpreads.length).toFixed(1):null;
      const spreadTeam = validSpreads.length? validSpreads[0].spread.team : '';
      const awayProbs = game.odds.map(o=>o.moneyline?.away?americanToProb(o.moneyline.away):null).filter(p=>p!==null);
      const homeProbs = game.odds.map(o=>o.moneyline?.home?americanToProb(o.moneyline.home):null).filter(p=>p!==null);
      const avgAway = awayProbs.length? awayProbs.reduce((s,p)=>s+p,0)/awayProbs.length : 0;
      const avgHome = homeProbs.length? homeProbs.reduce((s,p)=>s+p,0)/homeProbs.length : 0;
      const tot = avgAway+avgHome || 1;
      const aggAwayMl = probToAmerican(avgAway/tot);
      const aggHomeMl = probToAmerican(avgHome/tot);
      const validTotals = game.odds.filter(o=>o.total?.value);
      const avgTotal = validTotals.length? (validTotals.reduce((s,o)=>s+o.total.value,0)/validTotals.length).toFixed(1):null;

      const aggregateRowHtml = `
        <tr class="aggregate-row border-b border-gray-600">
          <td class="p-3 font-semibold italic">Aggregate Line</td>
          <td class="p-3 text-center">${avgSpread&&spreadTeam? `${spreadTeam.substring(0,3).toUpperCase()} ${avgSpread}`:'N/A'}</td>
          <td class="p-3 text-center">
            <div class="p-1">${isFinite(aggAwayMl)?formatOdds(aggAwayMl):'N/A'}</div>
            <div class="p-1 mt-1">${isFinite(aggHomeMl)?formatOdds(aggHomeMl):''}</div>
          </td>
          <td class="p-3 text-center">${avgTotal?`O/U ${avgTotal}`:'N/A'}</td>
          <td class="p-3 text-center">-</td>
        </tr>`;

      const rows = game.odds.map(o=>{
        const isBestAway = bestAway!=null && o.moneyline?.away===bestAway;
        const isBestHome = bestHome!=null && o.moneyline?.home===bestHome;
        return `
          <tr class="border-b border-gray-700 hover:bg-gray-700/50">
            <td class="p-3 font-semibold">${o.sportsbook}</td>
            <td class="p-3 text-center">${o.spread? `${o.spread.team.substring(0,3).toUpperCase()} ${o.spread.value} <span class="text-gray-400">(${formatOdds(o.spread.odds)})</span>`:'N/A'}</td>
            <td class="p-3 text-center">
              ${o.moneyline? `
                 <div class="p-1 ${isBestAway?'best-odd':''}">${formatOdds(o.moneyline.away)}</div>
                 <div class="p-1 mt-1 ${isBestHome?'best-odd':''}">${formatOdds(o.moneyline.home)}</div>`:'N/A'}
            </td>
            <td class="p-3 text-center">
              ${o.total? `O ${o.total.value} <span class="text-gray-400">(${formatOdds(o.total.over)})</span><br/>U ${o.total.value} <span class="text-gray-400">(${formatOdds(o.total.under)})</span>`:'N/A'}
            </td>
            <td class="p-3 text-center">
              ${o.spread? `<button title="Add Spread to Editor's Choice" class="btn-add text-gray-500 hover:text-amber-400" data-game-id="${game.id}" data-sportsbook="${o.sportsbook}" data-type="spread">➕</button>`:''}
            </td>
          </tr>`;
      }).join('');

      container.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-800 border-b-2 border-gray-600">
              <tr><th class="p-3 text-left">Book</th><th class="p-3 text-center">Spread</th><th class="p-3 text-center">Moneyline</th><th class="p-3 text-center">Total</th><th class="p-3 text-center">Pick</th></tr>
            </thead>
            <tbody>${aggregateRowHtml}${rows}</tbody>
          </table>
        </div>`;
    };

    const renderTopPicks = (top)=>{ 
      if(!topPicksContainer) return;
      topPicksContainer.innerHTML = top.length? '' : `<p class="col-span-full text-gray-400 italic">Calculating top bets...</p>`;
      top.forEach(p=>{
        const el=document.createElement('div');
        el.className='top-pick-card rounded-lg shadow-lg p-4 flex flex-col justify-between';
        el.innerHTML = `
          <div><p class="text-xs text-gray-400">${p.awayTeam} @ ${p.homeTeam}</p>
          <p class="text-lg font-bold my-1">${p.teamToBet}</p><p class="text-sm font-semibold text-gray-300">Moneyline</p></div>
          <div class="bg-gray-900 rounded-md p-2 mt-3 text-center">
            <p class="text-sm font-bold text-emerald-400">${p.bestBook}</p>
            <p class="font-bold text-white text-xl">${formatOdds(p.bestOdds)}</p>
            <p class="text-xs text-gray-400 mt-1">~${(p.aggregateProbability*100).toFixed(1)}% Win Chance</p></div>`;
        topPicksContainer.appendChild(el);
      });
    };

    // ===== Player Props =====
    function processPlayerPropsFromEvent(eventData) {
      const playerProps = {};
      const KEYS = ['player_pass_yds','player_pass_tds','player_rush_yds','player_reception_yds','player_anytime_td'];
      eventData.bookmakers?.forEach(bm=>{
        bm.markets?.forEach(m=>{
          if(!KEYS.includes(m.key)) return;
          m.outcomes?.forEach(out=>{
            const player = out.description; if(!player) return;
            const prop = m.key;
            playerProps[player] ??= {};
            playerProps[player][prop] ??= {};
            const over = m.outcomes.find(o=>o.description===player && o.name==='Over');
            const under = m.outcomes.find(o=>o.description===player && o.name==='Under');
            if (over && under && !playerProps[player][prop][bm.title]) {
              playerProps[player][prop][bm.title] = { point: over.point, over: over.price, under: under.price };
            }
          });
        });
      });
      return playerProps;
    }

    const renderPlayerProps = (gameId, eventData) => {
      const container = document.getElementById(`player-props-${gameId}`);
      if (!container) return;

      const allPlayerProps = processPlayerPropsFromEvent(eventData);
      let html = '<div class="space-y-4">';
      if (Object.keys(allPlayerProps).length > 0) {
        for (const [player, props] of Object.entries(allPlayerProps)) {
          html += `<div class="card rounded-lg p-3"><h4 class="font-bold text-amber-400">${player}</h4><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-2">`;
          for (const [prop, books] of Object.entries(props)) {
            html += `<div class="bg-gray-900 p-2 rounded-md text-xs">`;
            html += `<p class="font-semibold text-gray-300 capitalize">${prop.replace(/player_/g, '').replace(/_/g, ' ')}</p>`;

            const booksData = Object.values(books);
            if (booksData.length > 0) {
              const avgPoint = booksData.reduce((sum, d) => sum + d.point, 0) / booksData.length;
              const avgOver  = booksData.reduce((sum, d) => sum + d.over, 0) / booksData.length;
              const avgUnder = booksData.reduce((sum, d) => sum + d.under, 0) / booksData.length;
              html += `
                <div class="flex justify-between items-center my-1 font-bold aggregate-row rounded px-1 text-xs">
                  <span>Aggregate</span>
                  <span class="font-mono">${avgPoint.toFixed(1)} (O: ${formatOdds(avgOver)} / U: ${formatOdds(avgUnder)})</span>
                </div>`;
            }

            Object.entries(books).forEach(([book, odds]) => {
              html += `<div class="flex justify-between items-center mt-1 border-t border-gray-700 pt-1">
                <span>${book}</span>
                <span class="font-mono">${odds.point} (O: ${formatOdds(odds.over)} / U: ${formatOdds(odds.under)})</span>
              </div>`;
            });
            html += `</div>`;
          }
          html += `</div></div>`;
        }
      } else {
        html += `<p class="text-gray-400 text-center italic p-4">No player props available for this game yet.</p>`;
      }
      html += `</div>`;
      container.innerHTML = html;
    };

    function calculateAndRenderTopPlayerProps() {
      allPlayerPropBets.sort((a, b) => b.aggregateProbability - a.aggregateProbability);
      const top5 = allPlayerPropBets.slice(0, 5);
      // render
      if (!topPlayerPropsContainer) return;
      topPlayerPropsContainer.innerHTML = '';
      if (top5.length === 0) {
        topPlayerPropsContainer.innerHTML = `<p class="col-span-full text-gray-400 italic">Explore player props in the games below to populate this list.</p>`;
        return;
      }
      top5.forEach(prop => {
        const el=document.createElement('div');
        el.className='top-prop-card rounded-lg shadow-lg p-4 flex flex-col justify-between';
        el.innerHTML = `
          <div>
            <p class="text-xs text-gray-400">${prop.player}</p>
            <p class="text-lg font-bold my-1">${prop.propType.replace(/player_/g, '').replace(/_/g, ' ')}</p>
            <p class="text-sm font-semibold text-gray-300">${prop.side} ${prop.point}</p>
          </div>
          <div class="bg-gray-900 rounded-md p-2 mt-3 text-center">
            <p class="text-sm font-bold text-cyan-400">${prop.bestBook}</p>
            <p class="font-bold text-white text-xl">${formatOdds(prop.bestOdds)}</p>
            <p class="text-xs text-gray-400 mt-1">~${(prop.aggregateProbability * 100).toFixed(1)}% Hit Chance</p>
          </div>`;
        topPlayerPropsContainer.appendChild(el);
      });
    }

    // ===== Data shaping =====
    function processMainOddsData(data){
      return data.map(game=>({
        id: game.id,
        awayTeam: game.away_team,
        homeTeam: game.home_team,
        time: new Date(game.commence_time).toLocaleString(),
        odds: game.bookmakers
          .map(bm=>{
            const odds={ sportsbook: bm.title };
            const h2h=bm.markets.find(m=>m.key==='h2h');
            const spreads=bm.markets.find(m=>m.key==='spreads');
            const totals=bm.markets.find(m=>m.key==='totals');
            if(h2h) odds.moneyline={ away: h2h.outcomes.find(o=>o.name===game.away_team)?.price, home: h2h.outcomes.find(o=>o.name===game.home_team)?.price };
            if(spreads){ const fav=spreads.outcomes.find(o=>o.point<0); if(fav) odds.spread={ team:fav.name, value:fav.point, odds:fav.price }; }
            if(totals){ const over=totals.outcomes.find(o=>o.name==='Over'); const under=totals.outcomes.find(o=>o.name==='Under'); if(over&&under) odds.total={ value: over.point, over: over.price, under: under.price }; }
            return odds;
          }),
        propsFetched:false
      })).filter(g => g.odds.length); // only games with at least one book
    }

    function calcTopPicks(games){
      const bets=[];
      games.forEach(g=>{
        const a=g.odds.map(o=>o.moneyline?.away?americanToProb(o.moneyline.away):null).filter(p=>p!=null);
        const h=g.odds.map(o=>o.moneyline?.home?americanToProb(o.moneyline.home):null).filter(p=>p!=null);
        if(!a.length||!h.length) return;
        const avgA=a.reduce((s,p)=>s+p,0)/a.length, avgH=h.reduce((s,p)=>s+p,0)/h.length;
        const tot=avgA+avgH; const pA=avgA/tot, pH=avgH/tot;
        if(pA>0.5){ const best=Math.max(...g.odds.map(o=>o.moneyline?.away).filter(Number.isFinite)); const bestBook=g.odds.find(o=>o.moneyline?.away===best)?.sportsbook; bets.push({game:g, teamToBet:g.awayTeam, aggregateProbability:pA, bestBook, bestOdds:best}); }
        if(pH>0.5){ const best=Math.max(...g.odds.map(o=>o.moneyline?.home).filter(Number.isFinite)); const bestBook=g.odds.find(o=>o.moneyline?.home===best)?.sportsbook; bets.push({game:g, teamToBet:g.homeTeam, aggregateProbability:pH, bestBook, bestOdds:best}); }
      });
      bets.sort((x,y)=>y.aggregateProbability-x.aggregateProbability);
      return bets.slice(0,5).map(b=>({awayTeam:b.game.awayTeam,homeTeam:b.game.homeTeam,teamToBet:b.teamToBet,aggregateProbability:b.aggregateProbability,bestBook:b.bestBook,bestOdds:b.bestOdds}));
    }

    // ===== Fetchers =====
    async function fetchMainOdds(){
      if(!gamesContainer) return;
      gamesContainer.innerHTML='<div class="flex justify-center items-center py-12"><div class="loader"></div></div>';
      try{
        const url = new URL(`${window.location.origin}/api/odds`);
        url.searchParams.set('sport', SPORT);
        url.searchParams.set('regions', REGIONS);
        url.searchParams.set('markets', MAIN_MARKETS);
        url.searchParams.set('oddsFormat', ODDS_FORMAT);
        const r = await fetch(url, {cache: 'no-store'});
        if(!r.ok) throw new Error(`API Error ${r.status}`);
        const data=await r.json();
        fetchedGames=processMainOddsData(data);
        renderGames(fetchedGames);
        renderTopPicks(calcTopPicks(fetchedGames));
      }catch(e){
        let errorMessage = `Failed to fetch odds: ${e.message}.`;
        if (e.message.includes('404')) {
            errorMessage += `<br/><br/><strong>Development Tip:</strong> Are you running this with the Vercel CLI? For local development, you need to run <code class="bg-gray-700 p-1 rounded">'vercel dev'</code> to use the API routes.`;
        }
        gamesContainer.innerHTML = `<div class="card p-4 text-center text-red-400">${errorMessage}</div>`;
        console.error(e);
      }
    }

    async function fetchEventOdds(gameId, markets, type){
      const container=document.getElementById(`${type}-${gameId}`);
      if(!container) return;
      container.innerHTML='<div class="flex justify-center items-center py-8"><div class="loader"></div></div>';
      try{
        const url = new URL(`${window.location.origin}/api/events/${gameId}`);
        url.searchParams.set('sport', SPORT);
        url.searchParams.set('regions', REGIONS);
        url.searchParams.set('markets', markets);
        url.searchParams.set('oddsFormat', ODDS_FORMAT);
        const r = await fetch(url, {cache: 'no-store'});
        if(!r.ok) throw new Error(`API Error ${r.status}`);
        const eventDataArray = await r.json();
        const eventData = eventDataArray[0] || {};

        // Render props panel per game
        renderPlayerProps(gameId, eventData);

        // Aggregate for the global "Top 5 Player Props"
        const propsObj = processPlayerPropsFromEvent(eventData);
        for (const [player, propTypes] of Object.entries(propsObj)) {
          for (const [propType, books] of Object.entries(propTypes)) {
            const booksData = Object.values(books);
            if (!booksData.length) continue;

            const avgOver  = booksData.reduce((s,b)=>s+b.over,0)/booksData.length;
            const avgUnder = booksData.reduce((s,b)=>s+b.under,0)/booksData.length;
            const point    = booksData[0].point;
            const overProb = americanToProb(avgOver);
            const underProb= americanToProb(avgUnder);
            const tot = (overProb+underProb)||1;
            const pOver = overProb/tot, pUnder = underProb/tot;

            const bestOver = Math.max(...booksData.map(b=>b.over));
            const bestOverBook = Object.keys(books).find(k=>books[k].over===bestOver);

            const bestUnder = Math.max(...booksData.map(b=>b.under));
            const bestUnderBook = Object.keys(books).find(k=>books[k].under===bestUnder);

            allPlayerPropBets.push({player, propType, point, side:'Over',  aggregateProbability:pOver,  bestBook:bestOverBook,  bestOdds:bestOver});
            allPlayerPropBets.push({player, propType, point, side:'Under', aggregateProbability:pUnder, bestBook:bestUnderBook, bestOdds:bestUnder});
          }
        }
        calculateAndRenderTopPlayerProps();

      }catch(e){
        let errorMessage = `Could not load props: ${e.message}.`;
        if (e.message.includes('404')) {
             errorMessage += `<br/><br/><strong>Development Tip:</strong> Make sure you are running <code class="bg-gray-700 p-1 rounded">'vercel dev'</code>.`;
        }
        container.innerHTML=`<p class="text-red-400 text-center italic p-4">${errorMessage}</p>`;
        console.error(e);
      }
    }

    // Tabs
    gamesContainer?.addEventListener('click',(e)=>{
      const tab=e.target.closest('.tab'); if(tab){
        const card=tab.closest('.card'); const gameId=card.id;
        card.querySelectorAll('.tab').forEach(t=>t.classList.remove('tab-active'));
        card.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('tab-content-active'));
        tab.classList.add('tab-active'); const type=tab.dataset.tab;
        document.getElementById(`${type}-${gameId}`).classList.add('tab-content-active');
        const game=fetchedGames.find(g=>g.id===gameId);
        if(type==='player-props' && game && !game.propsFetched){
          game.propsFetched=true;
          fetchEventOdds(gameId, PROPS_MARKETS, 'player-props');
        }
      }
    });

    document.addEventListener('DOMContentLoaded', fetchMainOdds);
  </script>
</body>
</html>
